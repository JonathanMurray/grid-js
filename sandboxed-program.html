
<script src="grid.js"></script>
<script src="text-grid.js"></script>

<script>
    "use strict";

    const SYSCALLS = ["write", "exit", "readFromFile", "graphics", "saveToFile"];

    window.addEventListener("keydown", function(event) {
        if (event.code == "Tab") {
            event.preventDefault();
        }

        if (event.key == "s" && event.ctrlKey) {
            event.preventDefault();
        }
    });

    console.log("Initializing program iframe ...");

    let setSyscallResult;
    let asyncSyscallResult = null;

    function asyncSyscall(syscall, arg) {
        console.debug("posting syscall...");
        parent.postMessage({syscall: {syscall, arg}}, "*");
        console.debug("posted syscall...");
        console.assert(setSyscallResult == null, "Concurrent syscalls are not allowed");
        asyncSyscallResult = new Promise((resolve) => {
            setSyscallResult = resolve;
        });
        console.debug("created syscall promise...");
        
        return asyncSyscallResult;
    }

    // This object should appear exactly the same as the syscalls object provided by system.js
    const syscalls = {};
    
    for (let name of SYSCALLS) {
        syscalls[name] = arg => asyncSyscall(name, arg)
    };

    let eventHandler = null;
    // This should be called from applications
    function registerEventHandler(handler) {
        eventHandler = handler;
    }

    function runProgram(programCode, args) {
        document.getElementById("program-code").remove();
        const script = document.createElement("script");
        script.setAttribute("id", "program-code");

        programCode = "try {\n" + 
        "  const args = " + JSON.stringify(args) + ";\n" +
        "  // START OF PROGRAM\n" +
        programCode + "\n" +
        "  // END OF PROGRAM\n" +
        "  result = main(args);\n" + 
        "  console.debug('program result', result);\n" +
        "  Promise.resolve(result)\n" + 
        "    .then((value) => { console.debug('Program result:', value); })\n" +
        "    .catch((e) => { syscalls.write(['Program crashed:'].concat(e.stack.split('\\n'))); })\n" +
        "    .finally(() => { console.debug('exiting in finally'); syscalls.exit(); window.location.reload();})\n" +
        "} catch (e) {\n" +
        "  syscalls.write(['Program wrapper crashed:'].concat(e.stack.split('\\n')));\n" + 
        "  syscalls.exit();\n" + 
        "  window.location.reload();\n" +
        "}\n";

        console.debug("Running in sandboxed iframe: ", programCode);

        script.text = programCode;
        document.getElementsByTagName("body")[0].appendChild(script);
    }

    window.addEventListener("message", message => {

        if ("runProgram" in message.data) {
            console.assert("code" in message.data.runProgram);
            console.assert("args" in message.data.runProgram);
            runProgram(message.data.runProgram.code, message.data.runProgram.args);
        } else if ("syscallResult" in message.data) {
            let result = message.data.syscallResult;
            console.debug("Received syscall result in iframe: ", result);
            setSyscallResult(result);
            setSyscallResult = null; // Allow for a new syscall to happen later
        } else {
            console.assert("killProgram" in message.data);
            console.debug("reloading iframe...");
            window.location.reload();
            console.debug("reloaded iframe.");
        }
    });

</script>
    

<script id="program-code"></script>