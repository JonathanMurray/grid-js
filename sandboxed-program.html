
<script src="grid.js"></script>
<script src="text-grid.js"></script>

<script>
    "use strict";

    const SYSCALLS = ["read", "write", "exit", "readFromFile", "graphics", "saveToFile", 
        "listFiles", "spawn", "kill", "waitForExit", "controlTerminal", "listProcesses"];

    let pid = null; // Set from message sent from system

    window.addEventListener("keydown", function(event) {
        if (event.code == "Tab") {
            event.preventDefault();
        }

        if (event.key == "s" && event.ctrlKey) {
            event.preventDefault();
        }
    });

    console.log("Initializing program iframe ...");

    let resolveSyscallPromise;
    let rejectSyscallPromise;

    function asyncSyscall(syscall, arg) {
        console.debug("posting syscall...");
        console.assert(pid != null, "pid must have been assigned");
        parent.postMessage({syscall: {syscall, arg, pid}}, "*");
        console.debug("posted syscall...");
        console.assert(resolveSyscallPromise == null, "Concurrent syscalls are not allowed");
        console.assert(rejectSyscallPromise == null, "Concurrent syscalls are not allowed");
        const asyncSyscallResult = new Promise((resolve, reject) => {
            resolveSyscallPromise = resolve;
            rejectSyscallPromise = reject;
        });
        console.debug("created syscall promise...");
        
        return asyncSyscallResult;
    }

    // This object should appear exactly the same as the syscalls object provided by system.js
    const syscalls = {};
    for (let name of SYSCALLS) {
        syscalls[name] = arg => asyncSyscall(name, arg)
    };

    function runProgram(programCode, args) {

        programCode = "try {\n" + 
        "  const args = " + JSON.stringify(args) + ";\n" +
        "  // START OF PROGRAM\n" +
        programCode + "\n" +
        "  // END OF PROGRAM\n" +
        "  result = main(args);\n" + 
        "  console.debug('program result', result);\n" +
        "  Promise.resolve(result)\n" + 
        "    .then((value) => { console.debug('Program result:', value); })\n" +
        "    .catch((e) => { syscalls.write(['Program crashed:'].concat(e.stack.split('\\n'))); })\n" +
        "    .finally(() => { console.debug('exiting in finally'); syscalls.exit();})\n" +
        "} catch (e) {\n" +
        "  syscalls.write(['Program wrapper crashed:'].concat(e.stack.split('\\n')));\n" + 
        "  syscalls.exit();\n" + 
        "}\n";

        console.debug("Running in sandboxed iframe: ", programCode);

        const script = document.createElement("script");
        script.text = programCode;
        document.getElementsByTagName("body")[0].appendChild(script);
    }

    window.addEventListener("message", message => {

        console.debug("Sandboxed program received message:", message.data);

        if ("startProcess" in message.data) {
            console.assert("code" in message.data.startProcess);
            console.assert("args" in message.data.startProcess);
            console.assert("pid" in message.data.startProcess);
            pid = message.data.startProcess.pid;
            runProgram(message.data.startProcess.code, message.data.startProcess.args);
        } else if ("syscallResult" in message.data) {
            if ("success" in message.data.syscallResult) {
                let result = message.data.syscallResult.success;
                console.debug("Received syscall result in iframe: ", result);
                resolveSyscallPromise(result);
                 // Allow for a new syscall to happen later
                resolveSyscallPromise = null;
                rejectSyscallPromise = null;
            } else {
                console.assert("error" in message.data.syscallResult);
                let error = message.data.syscallResult.error;
                console.log("Received syscall error in iframe: ", error);
                rejectSyscallPromise(error);
                 // Allow for a new syscall to happen later
                resolveSyscallPromise = null;
                rejectSyscallPromise = null;
            }
        } else {
            console.error("Unhandled message in program iframe", message.data);
        }
    });

</script>