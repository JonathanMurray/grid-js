<html>
<head>
    <style>
        canvas {
            outline: none
        }
        canvas.focused {
            outline:  dashed purple 2px;
        }
    </style>
</head>
<body>
    <div>
        <canvas id="terminal-canvas" tabindex="0" width="500" height="200" style="border:1px solid #000000"></canvas>
    </div>
    
    <div id="program-window" hidden style="position: absolute; border: 2px solid lightgray; background: white; user-select: none;">
        <div id="program-window-header" style="background:lightgray; font-family: system-ui; font-weight: bold;">
            Program sandbox
        </div>
        <iframe id="program-iframe" sandbox="allow-scripts" src="sandboxed-program.html"></iframe>
    </div>

</body>

<script src="grid.js"></script>
<script src="text-grid.js"></script>
<script src="terminal.js"></script>
<script src="system.js"></script>

<script>

const canvas = document.getElementById("terminal-canvas");

const programIframe = document.getElementById("program-iframe");

const system = new System();

const terminal = new Terminal(canvas, system);
system.initTerminal(terminal);

window.addEventListener("keydown", function(event) {
    if (event.code == "Tab") {
        event.preventDefault();
    }

    if (event.key == "s" && event.ctrlKey) {
        event.preventDefault();
    }
});

terminal.setFocused(true);
canvas.classList.add("focused");
canvas.focus();

window.addEventListener("keydown", function(event) {
    system.handleEvent("keydown", event);
});

let draggingWindowOffset = null;

const programContainer = document.getElementById("program-window");
programContainer.addEventListener("mousedown", (event) => {
    const left = parseInt(programContainer.style.left.replace("px", "")) || programContainer.getBoundingClientRect().x;
    const top = parseInt(programContainer.style.top.replace("px", "")) || programContainer.getBoundingClientRect().y;
    draggingWindowOffset = [event.x - left, event.y - top];

    programIframe.focus();
});

window.addEventListener("mousemove", (event) => {
    if (draggingWindowOffset != null) {
        programContainer.style.left = event.x - draggingWindowOffset[0];
        programContainer.style.top = event.y - draggingWindowOffset[1];

        programIframe.focus();
    }
});

window.addEventListener("mouseup", (event) => {
    if (draggingWindowOffset != null) {
        draggingWindowOffset = null;

        programIframe.focus();
    }
});

window.addEventListener("message", event => {
    // Sandboxed programs send us syscalls from iframe
    console.assert("syscall" in event.data);
    const result = system.call(event.data.syscall.syscall, event.data.syscall.arg);
    console.debug("syscall result", event.data.syscall.syscall, event.data.syscall.arg, result);
    const iframe = document.getElementById("program-iframe");
    iframe.contentWindow.postMessage({syscallResult: result}, "*");
    console.debug("Sent syscall result to program iframe");
});

</script>


</html>

